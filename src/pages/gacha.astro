---
import Layout from '../layouts/Layout.astro';
import itemsData from '../data/items.json';
---

<Layout title="ê°€ì± ">
  <div class="container">
    <h1>âœ¨ ëœë¤ ë°•ìŠ¤ ê°€ì±  âœ¨</h1>

    <div class="gacha-section">
      <div class="gacha-types">
        <div class="gacha-box normal-box">
          <div class="box-animation">
            <div class="gift-box">ğŸ“¦</div>
          </div>
          <h3>ì¼ë°˜ ëœë¤ ë°•ìŠ¤</h3>
          <p class="box-subtitle">ì¼ë°˜ ë“±ê¸‰ ì•„ì´í…œ íšë“</p>
          <button id="normalGachaBtn" class="gacha-btn normal-btn">
            <span class="btn-text">5ì—°ì°¨ ê°€ì± !</span>
          </button>
        </div>

        <div class="gacha-box premium-box">
          <div class="box-animation">
            <div class="gift-box premium">ğŸ</div>
          </div>
          <h3>ê³ ê¸‰ ëœë¤ ë°•ìŠ¤</h3>
          <p class="box-subtitle">í¬ê·€ ë“±ê¸‰ ì•„ì´í…œ ë“±ì¥!</p>
          <button id="premiumGachaBtn" class="gacha-btn premium-btn">
            <span class="btn-sparkle">âœ¨</span>
            <span class="btn-text">3ì—°ì°¨ ê°€ì± !</span>
            <span class="btn-sparkle">âœ¨</span>
          </button>
        </div>
      </div>

      <div id="result" class="result-section" style="display:none;">
        <div class="result-header">
          <h2 id="resultTitle">ğŸ‰ ê°€ì±  ê²°ê³¼ ğŸ‰</h2>
        </div>

        <div id="captureArea" class="capture-area">
          <div class="capture-header">
            <div class="cap-left">
              <div class="cap-badge">ASTROLABE</div>
              <div class="cap-title" id="capTitle">ëœë¤ ë°•ìŠ¤ ê²°ê³¼</div>
              <div class="cap-sub" id="capSub">â€”</div>
            </div>

            <div class="cap-right">
              <div class="cap-tag" id="capTag">NORMAL</div>
              <div class="cap-time" id="capTime">0000-00-00 00:00</div>
            </div>
          </div>

          <div id="itemGrid" class="item-grid"></div>

          <div class="capture-footer">
            <div class="cap-foot-left">Â© ë‚™ì„±ì¢…ì–¸</div>
            <div class="cap-foot-right" id="capFootRight">ASTROLABE SYSTEM</div>
          </div>
        </div>

        <button id="downloadBtn" class="download-btn">
          <span>ğŸ“¥</span> ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°
        </button>
      </div>
    </div>
  </div>
</Layout>

<style is:global>
/* =========================
   PAGE
========================= */
.gacha-section{ text-align:center; position:relative; }

.gacha-types{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:3rem;
  margin:2rem auto 3rem;
  max-width:900px;
}

.gacha-box{
  background:linear-gradient(135deg,#f0f8ff 0%,#ffffff 100%);
  padding:2.5rem;
  border-radius:25px;
  border:3px solid #e3f2fd;
  transition:all .3s;
}
.normal-box{ border-color:#b0bec5; }
.premium-box{
  border-color:#ffd700;
  background:linear-gradient(135deg,#fffaf0 0%,#fff8dc 100%);
}

.gift-box{ font-size:6rem; animation:float 3s ease-in-out infinite; }
.gift-box.premium{ animation:floatPremium 3s ease-in-out infinite; }
@keyframes float{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
@keyframes floatPremium{ 0%,100%{transform:translateY(0) rotate(-5deg)} 50%{transform:translateY(-20px) rotate(5deg)} }

.gacha-btn{
  font-size:1.3rem;
  padding:1rem 2rem;
  display:inline-flex;
  align-items:center;
  gap:.5rem;
  border:none;
  border-radius:16px;
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.normal-btn{ background:linear-gradient(135deg,#78909c 0%,#90a4ae 100%); }
.premium-btn{
  background:linear-gradient(135deg,#daa520 0%,#ffd700 100%);
  color:#2a1a00;
}

/* =========================
   RESULT HEADER
========================= */
.result-section{ margin-top:3rem; }
.result-header{ margin-bottom:1.25rem; }
.result-header h2{ font-size:2.2rem; font-weight:900; color:#0b2a4a; }

/* =========================
   CAPTURE AREA (16:9)
========================= */
#captureArea{
  position: relative;
  aspect-ratio: 16 / 9;
  max-width: 1100px;
  margin: 0 auto;
  padding: 22px 22px 18px;

  /* âœ… ìº¡ì²˜ ì•ˆì •: ë¶ˆíˆ¬ëª… ë°°ê²½(í•˜ì–€ ìº¡ì²˜ ë°©ì§€) */
  background: linear-gradient(180deg, #eef9ff 0%, #d6efff 55%, #c8e8ff 100%);
  border: 1px solid rgba(30,120,200,.22);

  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: 12px;

  overflow: hidden; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
}

/* header/footer */
.capture-header{
  position: relative;
  z-index: 3;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 14px;
  padding: 8px 10px 6px;
}
.cap-left{ display:flex; flex-direction:column; gap:6px; align-items:flex-start; }

.cap-badge{
  font-weight: 900;
  font-size: 0.72rem;
  letter-spacing: .14em;
  color:#0b2a4a;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(0,120,255,0.18);
  backdrop-filter: blur(8px);
  box-shadow: 0 8px 18px rgba(0,70,140,.12);
}
.cap-title{
  font-weight: 1000;
  font-size: 1.35rem;
  letter-spacing: -0.03em;
  color:#07223a;
  text-shadow: 0 1px 0 rgba(255,255,255,0.75);
}
.cap-sub{
  font-weight: 700;
  font-size: 0.85rem;
  color: rgba(7,34,58,0.65);
}

.cap-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap: 6px;
}
.cap-tag{
  font-weight: 1000;
  font-size: 0.75rem;
  letter-spacing: .10em;
  padding: 6px 10px;
  border-radius: 999px;
  color:#ffffff;
  background: linear-gradient(180deg, #7bd1ff 0%, #4aa9ff 100%);
  box-shadow: 0 12px 22px rgba(0,120,255,.22);
}
.cap-time{
  font-size: 0.78rem;
  color: rgba(7,34,58,0.55);
}

.capture-footer{
  position: relative;
  z-index: 3;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding: 6px 10px 2px;
  font-size: 0.78rem;
  color: rgba(7,34,58,0.6);
}
.cap-foot-right{
  font-weight: 900;
  color: rgba(7,34,58,0.75);
}

/* =========================
   GRID (5ì¹¸ ê³ ì •)
========================= */
#itemGrid{
  position: relative;
  z-index: 3;
  align-self: center;

  display:grid;
  grid-template-columns: repeat(5, 170px);
  gap: 14px;
  justify-content: center;
}

/* =========================
   CARD
========================= */
.item-card{
  width:170px;
  border-radius:16px;
  overflow:hidden;
  background:linear-gradient(180deg,rgba(255,255,255,.92) 0%,rgba(255,255,255,.78) 100%);
  border:1px solid rgba(35,120,200,.25);
  box-shadow:0 10px 24px rgba(0,70,140,.18);
  transition:transform .18s ease, border-color .18s ease;
}


.item-icon-wrapper{
  position:relative;
  height:72px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding-top:10px;

  background: transparent;
  border-bottom:none;
}

.item-icon{
  width: 40px;
  height: 40px;
  object-fit: contain;
  image-rendering: pixelated;
  margin-top: 30px;
}

.rarity-chip{
  position:absolute;
  top: 8px;
  left: 8px;

  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;

  height: 23px;
  padding: 0 10px;
  border-radius:999px;

  font-weight:900;
  font-size:.5rem;
  line-height:1;
  background:rgba(255,255,255,.55);
  border:1px solid rgba(0,120,255,.22);
  color:#0b2a4a;
}
.rarity-dot{
  width:8px; height:8px;
  flex:0 0 8px;
  border-radius:999px;
  background:#2a9df4;
}
.rarity-text{ line-height:1; transform: translateY(-0.3px); }

.item-info{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:10px 10px 12px;
  gap:6px;
}

.item-name{
  font-weight:600;
  font-size:1rem;
  line-height:1.15;
  letter-spacing:-.03em;
  color:#082642;
  text-align:center;
  margin:0;
}
.item-name.is-long{
  font-size:0.85rem;
  letter-spacing:-.04em;
}

.item-description{
  --lh: 1.45;
  font-size: 0.70rem;
  line-height: var(--lh);
  color: rgba(8, 38, 66, 0.55);
  text-align: center;
  max-width: 130px;
  word-break: keep-all;

  /* 2ì¤„ ê³ ì • + ê°€ìš´ë° ì •ë ¬ */
  height: calc(var(--lh) * 1em * 2);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

/* =========================
   DOWNLOAD BTN
========================= */
.download-btn{
  margin-top:18px;
  padding:12px 22px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  font-weight:900;
  color:#fff;
  background:linear-gradient(180deg,#7bd1ff 0%,#4aa9ff 100%);
  box-shadow:0 12px 22px rgba(0,120,255,.22);
}

.item-description{
  --lh: 1.45;
  line-height: var(--lh);

  height: calc(var(--lh) * 1em * 2); /* 2ì¤„ ë†’ì´ */
  display: flex;
  align-items: center;
  justify-content: center;

  overflow: hidden; /* ì¤„ì´ê¸° ì‹¤íŒ¨í•´ë„ íŠ€ì–´ë‚˜ì˜¤ì§„ ì•Šê²Œ */
  text-align: center;
  max-width: 130px;
  word-break: keep-all;
}

.item-card{
  display: flex;
  flex-direction: column;
}

.item-grid{
  display:grid;
  grid-template-columns: repeat(5, 170px);
  gap:14px;
  justify-content:center;

  align-items:end; /* âœ… í•µì‹¬: ê°™ì€ ì¤„ì—ì„œ ì§§ì€ ì• ë“¤ì€ ì•„ë˜ ê³ ì • */
}

.item-description{
  --lh: 1.45;

  font-size: 0.70rem;
  line-height: var(--lh);
  color: rgba(8, 38, 66, 0.55);
  text-align: center;
  max-width: 130px;
  word-break: keep-all;

  /* âœ… ê¸°ë³¸ì€ 2ì¤„ ë°•ìŠ¤ ê³ ì • + ì¤‘ì•™ ì •ë ¬ */
  height: calc(var(--lh) * 1em * 2);
  display: flex;
  align-items: center;
  justify-content: center;

  overflow: hidden;
}


/* âœ… ê¸´ ì„¤ëª…(3ì¤„ ì´ìƒ)ì¸ ì¹´ë“œë§Œ í’€ì–´ì£¼ê¸° */
.item-card.desc-long .item-description{
  height: auto;          /* âœ… ê³ ì • í•´ì œ */
  display: block;        /* âœ… ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆ */
  padding-top: 2px;
  padding-bottom: 2px;
  overflow: visible;
}

.item-grid{
  --cardH: 260px;               /* âœ… ë³´í†µ ì¹´ë“œ ê¸°ì¤€ ë†’ì´ (ì›í•˜ë©´ ìˆ«ìë§Œ ì¡°ì ˆ) */

  display:grid;
  grid-template-columns: repeat(5, 170px);
  grid-auto-rows: var(--cardH); /* âœ… í–‰ ë†’ì´ ê³ ì • */
  gap:14px;
  justify-content:center;

  align-items:center;           /* âœ… ë‹¤ë¥¸ ì¹´ë“œë“¤ â€œí–‰ ì¤‘ì•™â€ ìœ ì§€ */
  overflow: visible;            /* âœ… ì»¤ì§€ëŠ” ì¹´ë“œê°€ ìœ„/ì•„ë˜ë¡œ íŠ€ì–´ë‚˜ì™€ë„ ë³´ì´ê²Œ */
}


</style>

<script define:vars={{ itemsData }}>
  const normalGachaBtn = document.getElementById('normalGachaBtn');
  const premiumGachaBtn = document.getElementById('premiumGachaBtn');
  const resultSection = document.getElementById('result');
  const resultTitle = document.getElementById('resultTitle');
  const itemGrid = document.getElementById('itemGrid');
  const downloadBtn = document.getElementById('downloadBtn');

  const allItems = itemsData.filter((item) => !String(item.icon || '').includes('ë³„ë¹›ìƒì.gif'));
  const commonItems = allItems.filter((item) => item.rarity === 'common');
  const rareItems = allItems.filter((item) => item.rarity === 'rare');

  function drawGacha(isPremium = false) {
    const results = [];
    const pool = isPremium ? rareItems : commonItems;
    const count = isPremium ? 3 : 5;
    for (let i = 0; i < count; i++) results.push(pool[Math.floor(Math.random() * pool.length)]);
    return results;
  }

  function setCaptureHeader(boxType){
    const capTitle = document.getElementById('capTitle');
    const capSub = document.getElementById('capSub');
    const capTag = document.getElementById('capTag');
    const capTime = document.getElementById('capTime');
    if (!capTitle || !capSub || !capTag || !capTime) return;

    const isPremium = boxType === 'premium';
    capTitle.textContent = isPremium ? 'ê³ ê¸‰ ëœë¤ ë°•ìŠ¤ ê²°ê³¼' : 'ì¼ë°˜ ëœë¤ ë°•ìŠ¤ ê²°ê³¼';
    capSub.textContent = isPremium ? 'ê³ ê¸‰ ì•„ì´í…œ íšë“' : 'ì¼ë°˜ ì•„ì´í…œ íšë“';
    capTag.textContent = isPremium ? 'PREMIUM' : 'NORMAL';

    const d = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    capTime.textContent =
      `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ` +
      `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // âœ… íˆìŠ¤í† ë¦¬ ì €ì¥(ì „ì—­) â€” displayResults ë°–!
  function saveHistory(results, boxType){
    try {
      const history = JSON.parse(localStorage.getItem('gachaHistory') || '[]');
      history.push({
        timestamp: Date.now(),
        boxType, // 'normal' | 'premium'
        results: results.map(r => ({ name: r.name, rarity: r.rarity }))
      });
      localStorage.setItem('gachaHistory', JSON.stringify(history));
    } catch (e) {
      console.warn('saveHistory failed:', e);
    }
  }

  // âœ… ì„¤ëª… ìë™ í°íŠ¸ ì¶•ì†Œ(2ì¤„ ì•ˆì— ìš°ê²¨ë„£ê¸°)
  function fitDescriptions(root){
    const els = Array.from(root.querySelectorAll('.item-description'));
    els.forEach((el) => {
      const base = 0.70; // rem
      const min  = 0.60; // rem
      const step = 0.02; // rem

      el.style.fontSize = `${base}rem`;

      // í˜„ì¬ 2ì¤„ í—ˆìš© ë†’ì´(px)
      const cs = getComputedStyle(el);
      const lh = parseFloat(cs.lineHeight); // px
      const maxH = lh * 2 + 1; // ì˜¤ì°¨ ì—¬ìœ 

      let size = base;
      while (el.scrollHeight > maxH && size > min) {
        size = +(size - step).toFixed(2);
        el.style.fontSize = `${size}rem`;
      }
    });
  }

  // âœ… 3ì¤„ ì´ìƒì¸ ì„¤ëª…ë§Œ â€œì¹´ë“œ ë†’ì´ ëŠ˜ë¦¬ê¸°(desc-long)â€ íŒë³„
  function markLongDescriptions(root){
    const cards = Array.from(root.querySelectorAll('.item-card'));
    cards.forEach((card) => {
      card.classList.remove('desc-long');

      const descEl = card.querySelector('.item-description');
      if (!descEl) return;

      const cs = getComputedStyle(descEl);
      const lh = parseFloat(cs.lineHeight); // px
      const twoLines = lh * 2 + 1;

      if (descEl.scrollHeight > twoLines) {
        card.classList.add('desc-long');
      }
    });
  }

  function displayResults(results, boxType) {
    if (!itemGrid) return;

    itemGrid.innerHTML = '';
    setCaptureHeader(boxType);

    resultTitle.textContent = (boxType === 'premium')
      ? 'âœ¨ ê³ ê¸‰ ëœë¤ ë°•ìŠ¤ ê²°ê³¼ âœ¨'
      : 'ğŸ“¦ ì¼ë°˜ ëœë¤ ë°•ìŠ¤ ê²°ê³¼ ğŸ“¦';

    results.forEach((item, index) => {
      const nameClass = item.name.length >= 10 ? 'item-name is-long' : 'item-name';
      const card = document.createElement('div');
      card.className = `item-card ${item.rarity}`;

      // âœ… ê³ ê¸‰(3ê°œ)ì¼ ë•Œ ê°€ìš´ë° 3ì¹¸(2,3,4)
      if (boxType === 'premium') card.style.gridColumn = String(2 + index);

      const rarityLabel = item.rarity === 'rare' ? 'RARE' : 'COMMON';

      card.innerHTML = `
        <div class="item-icon-wrapper ${item.rarity}">
          <div class="rarity-chip ${item.rarity}">
            <span class="rarity-dot"></span>
            <span class="rarity-text">${rarityLabel}</span>
          </div>
          <img src="${item.icon}" class="item-icon" onerror="this.src='/icons/í‹°ì¼“.png'"/>
        </div>
        <div class="item-info">
          <div class="${nameClass}">${item.name}</div>
          <div class="item-description">${item.description || ''}</div>
        </div>
      `;

      itemGrid.appendChild(card);
    });

    // âœ… ì—¬ê¸°ì„œ â€œë”± 1ë²ˆâ€ ì €ì¥!
    saveHistory(results, boxType);

    resultSection.style.display = 'block';
    resultSection.scrollIntoView({ behavior: 'smooth' });

    // âœ… DOM ë Œë” í›„ì— ë†’ì´/í°íŠ¸ ì¡°ì •í•´ì•¼ ì •í™•í•¨
    requestAnimationFrame(() => {
      fitDescriptions(itemGrid);
      markLongDescriptions(itemGrid);
    });
  }

  normalGachaBtn?.addEventListener('click', () => displayResults(drawGacha(false), 'normal'));
  premiumGachaBtn?.addEventListener('click', () => displayResults(drawGacha(true), 'premium'));

  // =========================
  // download (ë„¤ê°€ ì“°ë˜ê±° ìœ ì§€)
  // =========================
  // =========================
// download â†’ GIFë¡œ ë³€ê²½
// =========================
downloadBtn?.addEventListener('click', async () => {
  const loadH2C = () =>
    new Promise((resolve, reject) => {
      if (window.html2canvas) return resolve(true);
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });

  // âœ… gif.js ë¡œë“œ
  const loadGifJS = () =>
    new Promise((resolve, reject) => {
      if (window.GIF) return resolve(true);
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });

  const cap = document.getElementById('captureArea');
  if (!cap) return;

  const waitImages = async (root) => {
    const imgs = Array.from(root.querySelectorAll('img'));
    await Promise.all(
      imgs.map((img) => new Promise((res) => {
        if (img.complete && img.naturalWidth > 0) return res(true);
        img.onload = () => res(true);
        img.onerror = () => res(true);
      }))
    );
  };

  try {
    // âœ… ë‘˜ ë‹¤ ë¡œë“œ
    await Promise.all([loadH2C(), loadGifJS()]);

    requestAnimationFrame(() => {
      if (itemGrid) {
        fitDescriptions(itemGrid);
        markLongDescriptions(itemGrid);
      }
    });
    await new Promise((r) => setTimeout(r, 60));

    if (document.fonts?.ready) await document.fonts.ready;
    await waitImages(cap);

    // âœ… html2canvasë¡œ ì´ë¯¸ì§€ ìƒì„±
    const canvas = await html2canvas(cap, {
      scale: 2,
      backgroundColor: '#eef9ff',
      useCORS: true,
      allowTaint: true,
      logging: false,
      foreignObjectRendering: false
    });

    // âœ… GIF ìƒì„±
    const gif = new GIF({
      workers: 2,
      quality: 10,
      workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'
    });

    // âœ… 1í”„ë ˆì„ë§Œ ì¶”ê°€ (ì •ì§€ ì´ë¯¸ì§€ GIF)
    gif.addFrame(canvas, { delay: 100 });

    gif.on('finished', (blob) => {
      const link = document.createElement('a');
      link.download = `gacha-result-${Date.now()}.gif`;
      link.href = URL.createObjectURL(blob);
      link.click();
    });

    gif.render();

  } catch (e) {
    console.warn('GIF ìƒì„± ì‹¤íŒ¨:', e);
    alert('GIF ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
});
</script>

